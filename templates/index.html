<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pavan's Job Tracker</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    :root{--bg:#0a0e17;--bg-card:#111827;--bg-hover:#1a2236;--bg-modal:#0f1525;--border:#1e293b;--text:#e2e8f0;--text-dim:#64748b;--text-muted:#475569;--accent:#38bdf8;--green:#22c55e;--yellow:#eab308;--orange:#f97316;--red:#ef4444;--purple:#a78bfa;--font-body:'DM Sans',-apple-system,sans-serif;--font-mono:'JetBrains Mono',monospace;--radius:10px}
    body{background:var(--bg);color:var(--text);font-family:var(--font-body);line-height:1.6;min-height:100vh;-webkit-font-smoothing:antialiased}
    ::-webkit-scrollbar{width:6px;height:6px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:#334155;border-radius:3px}
    @keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
    @keyframes scaleIn{from{opacity:0;transform:scale(.95)}to{opacity:1;transform:scale(1)}}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
    .anim-fade{animation:fadeUp .4s ease both}.anim-scale{animation:scaleIn .25s ease both}
    .skeleton{animation:pulse 1.5s ease-in-out infinite;background:var(--bg-hover);border-radius:var(--radius)}
    .shell{max-width:1360px;margin:0 auto;padding:0 24px}
    .hdr{border-bottom:1px solid var(--border);padding:16px 0;position:sticky;top:0;z-index:40;background:rgba(10,14,23,.88);backdrop-filter:blur(16px)}
    .hdr-inner{display:flex;align-items:center;justify-content:space-between}
    .hdr h1{font-family:var(--font-mono);font-size:19px;font-weight:700;letter-spacing:-.5px}
    .hdr h1 span{color:var(--accent)}
    .hdr-badges{display:flex;gap:8px;flex-wrap:wrap}
    .badge{font-family:var(--font-mono);font-size:11px;padding:3px 10px;border-radius:20px;border:1px solid rgba(56,189,248,.2);background:rgba(56,189,248,.06);color:var(--accent);cursor:pointer;transition:all .2s;user-select:none}
    .badge:hover{background:rgba(56,189,248,.15);border-color:var(--accent)}
    .badge.on{background:var(--accent);color:#0a0e17;border-color:var(--accent)}
    .badge-purple{border-color:rgba(167,139,250,.2);background:rgba(167,139,250,.06);color:var(--purple)}
    .badge-purple:hover{background:rgba(167,139,250,.15);border-color:var(--purple)}
    .badge-purple.on{background:var(--purple);color:#0a0e17;border-color:var(--purple)}
    .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:10px;margin:20px 0}
    .st{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:16px 18px;cursor:pointer;transition:all .2s}
    .st:hover{border-color:var(--accent);background:var(--bg-hover);transform:translateY(-1px)}
    .st.on{border-color:var(--accent);box-shadow:0 0 0 1px var(--accent)}
    .st-l{font-size:11px;color:var(--text-dim);text-transform:uppercase;letter-spacing:1px;font-weight:600}
    .st-v{font-family:var(--font-mono);font-size:26px;font-weight:700;margin-top:2px}
    .bar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:16px;padding:14px 18px;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius)}
    .bar input{flex:1;min-width:180px;background:var(--bg);border:1px solid var(--border);color:var(--text);font-family:var(--font-body);font-size:14px;padding:9px 14px;border-radius:8px;outline:none;transition:border .2s}
    .bar input:focus{border-color:var(--accent)}.bar input::placeholder{color:var(--text-muted)}
    .bar select{background:var(--bg);border:1px solid var(--border);color:var(--text);font-family:var(--font-body);font-size:13px;padding:9px 12px;border-radius:8px;outline:none;cursor:pointer}
    .pills{display:flex;gap:5px;flex-wrap:wrap}
    .pill{font-size:11px;font-weight:600;padding:5px 12px;border-radius:20px;border:1px solid var(--border);background:transparent;color:var(--text-dim);cursor:pointer;transition:all .2s;font-family:var(--font-body)}
    .pill:hover{border-color:var(--accent);color:var(--text)}
    .pill.on{background:var(--accent);color:#0a0e17;border-color:var(--accent)}
    .jgrid{display:flex;flex-direction:column;gap:6px;margin-bottom:20px}
    .jgrid-hdr{display:grid;grid-template-columns:54px 1fr 150px 90px 110px 72px;gap:14px;padding:0 18px;font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;font-weight:600}
    .jrow{display:grid;grid-template-columns:54px 1fr 150px 90px 110px 72px;align-items:center;gap:14px;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:12px 18px;cursor:pointer;transition:all .15s}
    .jrow:hover{border-color:#334155;background:var(--bg-hover);transform:translateX(2px)}
    .j-title{font-weight:600;font-size:13.5px;line-height:1.35}.j-co{font-size:12.5px;color:var(--text-dim);margin-top:1px}
    .j-loc{font-size:12.5px;color:var(--text-dim);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .j-src{font-family:var(--font-mono);font-size:10px;color:var(--purple);background:rgba(167,139,250,.06);padding:3px 7px;border-radius:4px;text-align:center}
    .j-time{font-size:11px;color:var(--text-muted);font-family:var(--font-mono)}
    .sbadge{font-size:10px;font-weight:600;padding:3px 9px;border-radius:20px;text-transform:uppercase;letter-spacing:.4px;text-align:center;white-space:nowrap}
    .s-new{background:rgba(56,189,248,.1);color:var(--accent)}.s-interested{background:rgba(167,139,250,.1);color:var(--purple)}
    .s-applied{background:rgba(234,179,8,.1);color:var(--yellow)}.s-interviewing{background:rgba(249,115,22,.1);color:var(--orange)}
    .s-offer{background:rgba(34,197,94,.12);color:var(--green)}.s-rejected{background:rgba(239,68,68,.1);color:var(--red)}
    .pgn{display:flex;justify-content:center;align-items:center;gap:6px;margin:20px 0 40px}
    .pg{background:var(--bg-card);border:1px solid var(--border);color:var(--text-dim);font-family:var(--font-mono);font-size:12px;padding:7px 13px;border-radius:8px;cursor:pointer;transition:all .2s}
    .pg:hover:not(:disabled){border-color:var(--accent);color:var(--text)}.pg:disabled{opacity:.3;cursor:not-allowed}
    .pg.on{background:var(--accent);color:#0a0e17;border-color:var(--accent)}.pg-info{font-size:12px;color:var(--text-muted)}
    .m-overlay{position:fixed;inset:0;z-index:100;background:rgba(0,0,0,.7);backdrop-filter:blur(6px);display:flex;align-items:flex-start;justify-content:center;padding:40px 20px;overflow-y:auto}
    .m-box{background:var(--bg-modal);border:1px solid var(--border);border-radius:14px;width:100%;max-width:700px;padding:28px;position:relative;animation:scaleIn .25s ease}
    .m-x{position:absolute;top:14px;right:14px;background:none;border:none;color:var(--text-dim);font-size:22px;cursor:pointer;width:34px;height:34px;display:flex;align-items:center;justify-content:center;border-radius:8px}
    .m-x:hover{color:var(--text);background:var(--bg-hover)}
    .m-hdr{display:flex;gap:14px;align-items:flex-start;margin-bottom:20px}
    .m-box h2{font-size:18px;font-weight:700;line-height:1.3}.m-meta{font-size:13px;color:var(--text-dim);margin-top:3px}
    .m-sec{margin-top:18px}.m-sec h3{font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--text-dim);font-weight:600;margin-bottom:6px}
    .m-desc{font-size:13px;line-height:1.7;color:var(--text);max-height:200px;overflow-y:auto;background:var(--bg);padding:14px;border-radius:8px;border:1px solid var(--border)}
    .m-actions{display:flex;gap:8px;margin-top:20px;flex-wrap:wrap}
    .btn{font-family:var(--font-body);font-size:13px;font-weight:600;padding:9px 18px;border-radius:8px;border:none;cursor:pointer;transition:all .2s;text-decoration:none;display:inline-flex;align-items:center;gap:5px}
    .btn-p{background:var(--accent);color:#0a0e17}.btn-p:hover{background:#7dd3fc}
    .btn-o{background:transparent;border:1px solid var(--border);color:var(--text)}.btn-o:hover{border-color:var(--accent)}
    .btn-d{background:transparent;border:1px solid rgba(239,68,68,.3);color:var(--red)}.btn-d:hover{background:rgba(239,68,68,.08)}
    .trk{display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap;margin-top:12px}
    .trk-f{display:flex;flex-direction:column;gap:3px}
    .trk-f label{font-size:11px;color:var(--text-dim);font-weight:600;text-transform:uppercase;letter-spacing:.5px}
    .trk-f select,.trk-f textarea{background:var(--bg);border:1px solid var(--border);color:var(--text);font-family:var(--font-body);font-size:13px;padding:9px 11px;border-radius:8px;outline:none;resize:vertical}
    .trk-f select{min-width:150px}.trk-f textarea{min-width:280px;min-height:56px}
    .empty{text-align:center;padding:70px 20px;color:var(--text-muted)}.empty p{font-size:14px}.empty .sub{font-size:12px;margin-top:6px}
    @media(max-width:900px){.jrow,.jgrid-hdr{grid-template-columns:50px 1fr}.jrow>:nth-child(n+3){display:none}.stats{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:600px){.stats{grid-template-columns:1fr}.bar{flex-direction:column}.bar input{width:100%}.m-box{padding:18px}}
  </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useCallback, useRef } = React;

const API = {
  stats:   ()       => fetch('/api/stats').then(r => r.json()),
  jobs:    (p)      => fetch('/api/jobs?' + new URLSearchParams(p)).then(r => r.json()),
  job:     (id)     => fetch('/api/job/'+id).then(r => r.json()),
  update:  (id, d)  => fetch('/api/job/'+id+'/status', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(d) }).then(r=>r.json()),
  archive: (id)     => fetch('/api/job/'+id, { method:'DELETE' }).then(r=>r.json()),
  filters: ()       => fetch('/api/filters').then(r => r.json()),
};

const STATUSES = ['new','interested','applied','interviewing','offer','rejected'];

function stripHtml(h) {
  if (!h) return '';
  const d = document.createElement('div'); d.innerHTML = h;
  return d.textContent || d.innerText || '';
}

function Ring({ score, size = 46 }) {
  const r = (size - 6) / 2, circ = 2 * Math.PI * r, pct = Math.min(score, 100) / 100;
  const clr = score >= 60 ? '#22c55e' : score >= 40 ? '#eab308' : score > 0 ? '#f97316' : '#475569';
  return (
    <svg width={size} height={size} style={{transform:'rotate(-90deg)',flexShrink:0}}>
      <circle cx={size/2} cy={size/2} r={r} fill="none" stroke="#1e293b" strokeWidth="3"/>
      <circle cx={size/2} cy={size/2} r={r} fill="none" stroke={clr} strokeWidth="3"
              strokeDasharray={circ} strokeDashoffset={circ*(1-pct)} strokeLinecap="round"
              style={{transition:'stroke-dashoffset .6s ease'}}/>
      <text x="50%" y="50%" dominantBaseline="central" textAnchor="middle"
            fill={clr} fontSize={size>50?16:12} fontWeight="700"
            fontFamily="JetBrains Mono,monospace" style={{transform:'rotate(90deg)',transformOrigin:'center'}}>
        {Math.round(score)}
      </text>
    </svg>
  );
}

function JobRow({ job, i, onClick }) {
  const sc = 's-'+(job.status||'new').toLowerCase();
  return (
    <div className="jrow anim-fade" style={{animationDelay:i*25+'ms'}} onClick={()=>onClick(job)}>
      <Ring score={job.score||0}/>
      <div><div className="j-title">{job.title||'Untitled'}</div><div className="j-co">{job.company||'Unknown'}</div></div>
      <div className="j-loc" title={job.location}>{job.location||'—'}</div>
      <div className="j-src">{job.source||'—'}</div>
      <div><span className={'sbadge '+sc}>{job.status||'new'}</span></div>
      <div className="j-time">{job.time_ago||'—'}</div>
    </div>
  );
}

function Modal({ job, onClose, onRefresh }) {
  const [status, setStatus] = useState(job.status||'new');
  const [notes, setNotes] = useState(job.notes||'');
  const [saving, setSaving] = useState(false);
  const save = async () => { setSaving(true); await API.update(job.job_id,{status,notes}); setSaving(false); onRefresh(); };
  const arch = async () => { if(!confirm('Archive this job?')) return; await API.archive(job.job_id); onClose(); onRefresh(); };
  useEffect(()=>{const h=e=>{if(e.key==='Escape')onClose()};window.addEventListener('keydown',h);return()=>window.removeEventListener('keydown',h)},[onClose]);
  const desc = stripHtml(job.description||'');
  return (
    <div className="m-overlay" onClick={e=>{if(e.target===e.currentTarget)onClose()}}>
      <div className="m-box anim-scale">
        <button className="m-x" onClick={onClose}>×</button>
        <div className="m-hdr">
          <Ring score={job.score||0} size={60}/>
          <div>
            <h2>{job.title}</h2>
            <div className="m-meta">{job.company} · {job.location||'N/A'} · {job.source}</div>
            {job.posted_date && <div className="m-meta">Posted: {job.posted_date}</div>}
          </div>
        </div>
        {job.score_explanation && (
          <div className="m-sec"><h3>Score Breakdown</h3>
            <div style={{fontSize:12,fontFamily:'var(--font-mono)',color:'var(--green)',whiteSpace:'pre-wrap',background:'var(--bg)',padding:10,borderRadius:8,border:'1px solid var(--border)'}}>
              {typeof job.score_explanation==='string' ? job.score_explanation : JSON.stringify(job.score_explanation,null,2)}
            </div>
          </div>
        )}
        {desc && (<div className="m-sec"><h3>Description</h3><div className="m-desc">{desc}</div></div>)}
        <div className="m-sec"><h3>Application Tracker</h3>
          <div className="trk">
            <div className="trk-f"><label>Status</label>
              <select value={status} onChange={e=>setStatus(e.target.value)}>
                {STATUSES.map(s=><option key={s} value={s}>{s[0].toUpperCase()+s.slice(1)}</option>)}
              </select>
            </div>
            <div className="trk-f" style={{flex:1}}><label>Notes</label>
              <textarea value={notes} onChange={e=>setNotes(e.target.value)} placeholder="Add notes..."/>
            </div>
          </div>
        </div>
        <div className="m-actions">
          {job.url && <a href={job.url} target="_blank" rel="noopener noreferrer" className="btn btn-p">Apply Now ↗</a>}
          <button className="btn btn-p" onClick={save} disabled={saving}>{saving?'Saving...':'✓ Save'}</button>
          <button className="btn btn-d" onClick={arch}>Archive</button>
          <button className="btn btn-o" onClick={onClose}>Close</button>
        </div>
        {job.applied_date && <div style={{marginTop:10,fontSize:11,color:'var(--text-muted)',fontFamily:'var(--font-mono)'}}>Applied: {job.applied_date}</div>}
      </div>
    </div>
  );
}

function App() {
  const [stats, setStats] = useState(null);
  const [jobs, setJobs] = useState([]);
  const [total, setTotal] = useState(0);
  const [pages, setPages] = useState(1);
  const [page, setPage] = useState(1);
  const [loading, setLoading] = useState(true);
  const [search, setSearch] = useState('');
  const [sortBy, setSort] = useState('score');
  const [sortOrd, setOrd] = useState('desc');
  const [stFilt, setStFilt] = useState('');
  const [srcFilt, setSrcFilt] = useState('');
  const [minSc, setMinSc] = useState(0);
  const [modal, setModal] = useState(null);
  const [srcs, setSrcs] = useState([]);
  const tmr = useRef(null);

  const loadStats = useCallback(async()=>{try{setStats(await API.stats())}catch(e){console.error(e)}},[]);
  const loadJobs = useCallback(async()=>{
    setLoading(true);
    try {
      const p = { page, per_page:25, sort_by:sortBy, sort_order:sortOrd };
      if(search) p.search=search;
      if(stFilt) p.status=stFilt;
      if(srcFilt) p.source=srcFilt;
      if(minSc>0) p.min_score=minSc;
      const d = await API.jobs(p);
      setJobs(d.jobs||[]); setTotal(d.total||0); setPages(d.total_pages||1);
    } catch(e){console.error(e)}
    setLoading(false);
  },[page,search,sortBy,sortOrd,stFilt,srcFilt,minSc]);

  useEffect(()=>{API.filters().then(d=>setSrcs(d.sources||[])).catch(()=>{})},[]);
  useEffect(()=>{loadStats()},[loadStats]);
  useEffect(()=>{loadJobs()},[loadJobs]);

  const onSearch = v => { clearTimeout(tmr.current); tmr.current=setTimeout(()=>{setSearch(v);setPage(1)},300) };
  const openModal = async job => { try{setModal(await API.job(job.job_id))}catch{setModal(job)} };
  const refresh = ()=>{ loadJobs(); loadStats() };

  // Feature 6: click source badge to filter
  const toggleSrc = (name) => {
    setSrcFilt(prev => prev === name ? '' : name);
    setPage(1);
  };

  const sc = [
    { l:'Total Jobs',   v:stats?.total_jobs||0,      f:'', c:'var(--accent)' },
    { l:'High Score',   v:stats?.high_score_jobs||0,  f:'', c:'var(--green)', act:()=>{setMinSc(m=>m===60?0:60);setPage(1)} },
    { l:'New (24h)',    v:stats?.new_jobs||0,         f:'', c:'var(--yellow)' },
    { l:'Applied',      v:stats?.status_stats?.find(s=>s.status==='applied')?.count||0, f:'applied', c:'var(--orange)' },
    { l:'Interviewing', v:stats?.status_stats?.find(s=>s.status==='interviewing')?.count||0, f:'interviewing', c:'var(--purple)' },
    { l:'Offers',       v:stats?.status_stats?.find(s=>s.status==='offer')?.count||0, f:'offer', c:'var(--green)' },
  ];

  return (
    <div>
      <div className="hdr"><div className="shell hdr-inner">
        <h1>⚡ <span>job</span>tracker</h1>
        <div className="hdr-badges">
          <span className={'badge'+(srcFilt===''&&!stFilt?' on':'')} onClick={()=>{setSrcFilt('');setStFilt('');setMinSc(0);setPage(1)}}>{total} jobs</span>
          {stats?.sources?.map(s=>(
            <span key={s.name} className={'badge badge-purple'+(srcFilt===s.name?' on':'')} onClick={()=>toggleSrc(s.name)}>
              {s.name}: {s.count}
            </span>
          ))}
        </div>
      </div></div>

      <div className="shell">
        <div className="stats">
          {sc.map((c,i)=>(
            <div key={i} className={'st anim-fade'+(stFilt===c.f&&c.f?' on':'')+(minSc===60&&c.l==='High Score'?' on':'')}
                 style={{animationDelay:i*50+'ms'}}
                 onClick={()=>{if(c.act){c.act();return}if(c.f){setStFilt(stFilt===c.f?'':c.f);setPage(1)}}}>
              <div className="st-l">{c.l}</div>
              <div className="st-v" style={{color:c.c}}>{c.v}</div>
            </div>
          ))}
        </div>

        <div className="bar">
          <input placeholder="Search jobs, companies, skills..." onChange={e=>onSearch(e.target.value)}/>
          <select value={srcFilt} onChange={e=>{setSrcFilt(e.target.value);setPage(1)}}>
            <option value="">All Sources</option>
            {srcs.map(s=><option key={s} value={s}>{s}</option>)}
          </select>
          <div className="pills">
            {['score','date','company'].map(s=>(
              <button key={s} className={'pill'+(sortBy===s?' on':'')}
                onClick={()=>{if(sortBy===s)setOrd(o=>o==='desc'?'asc':'desc');else{setSort(s);setOrd('desc')}}}>
                {s==='score'?'⬥ Score':s==='date'?'◷ Date':'◆ Company'}
                {sortBy===s&&(sortOrd==='desc'?' ↓':' ↑')}
              </button>
            ))}
          </div>
          <div className="pills">
            {STATUSES.map(s=>(
              <button key={s} className={'pill'+(stFilt===s?' on':'')}
                onClick={()=>{setStFilt(stFilt===s?'':s);setPage(1)}}>{s}</button>
            ))}
          </div>
        </div>

        {loading ? (
          <div className="jgrid">{[...Array(6)].map((_,i)=><div key={i} className="skeleton" style={{height:64}}/>)}</div>
        ) : jobs.length===0 ? (
          <div className="empty"><p>No jobs match your filters</p><p className="sub">Try adjusting your search or run the scraper</p></div>
        ) : (
          <div className="jgrid">
            <div className="jgrid-hdr"><div>Score</div><div>Job</div><div>Location</div><div>Source</div><div>Status</div><div>When</div></div>
            {jobs.map((j,i)=><JobRow key={j.job_id} job={j} i={i} onClick={openModal}/>)}
          </div>
        )}

        {pages>1&&(
          <div className="pgn">
            <button className="pg" disabled={page<=1} onClick={()=>setPage(p=>p-1)}>← Prev</button>
            {[...Array(Math.min(pages,7))].map((_,i)=>{
              let p;if(pages<=7)p=i+1;else if(page<=4)p=i+1;else if(page>=pages-3)p=pages-6+i;else p=page-3+i;
              return <button key={p} className={'pg'+(page===p?' on':'')} onClick={()=>setPage(p)}>{p}</button>
            })}
            <button className="pg" disabled={page>=pages} onClick={()=>setPage(p=>p+1)}>Next →</button>
            <span className="pg-info">{total} total</span>
          </div>
        )}
      </div>
      {modal&&<Modal job={modal} onClose={()=>setModal(null)} onRefresh={refresh}/>}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>